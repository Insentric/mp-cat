import{supabase}from"../js/supabaseClient.js";import{formatUtil}from"../js/formatUtility.js";const params=new URLSearchParams(window.location.search),itemId=params.get("id");function loadSearchBarTextInput(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e);if(t.rawSearch){const e=document.getElementById("searchInput"),n=document.getElementById("searchInputMobile");e&&(e.value=t.rawSearch),n&&(n.value=t.rawSearch)}}function setSearchPlaceholderText(){const e=document.getElementById("searchInput"),t=document.getElementById("searchInputMobile"),n="Search items...";e&&(e.placeholder=n),t&&(t.placeholder=n)}let thisItem,thisCategory;function isItemForSale(e){if(!e.discontinued_date)return!0;const t=new Date;return new Date(e.discontinued_date)>t}function renderPage(){const e=document.getElementById("item_name"),t=document.getElementById("item_acronym"),n=document.getElementById("ultra_rare"),a=document.getElementById("item_category"),s=document.getElementById("item_image"),i=document.getElementById("item_type"),o=document.getElementById("item_description"),r=document.getElementById("item_dates"),d=document.getElementById("item_animated"),c=document.getElementById("item_original_price"),m=document.getElementById("item_for_sale"),l=document.getElementById("item_value");if(e.textContent=thisItem.name,document.title=`${thisItem.name} | MP CAT`,thisItem.acronym?(t.classList.remove("hidden"),t.textContent=`(${thisItem.acronym})`):t.classList.add("hidden"),thisItem.ultra_rare?n.classList.remove("hidden"):n.classList.add("hidden"),a.textContent=thisCategory.name,s.src=thisItem.image_url,i.textContent=thisItem.type,o.textContent=thisItem.description,thisItem.release_date&&thisItem.discontinued_date){const e=formatUtil.formatDate(thisItem.release_date),t=formatUtil.formatDate(thisItem.discontinued_date),n=formatUtil.startOfDay(new Date),a=formatUtil.startOfDay(thisItem.release_date),s=formatUtil.startOfDay(thisItem.discontinued_date);let i="";if(s<n){const e=formatUtil.daysBetween(a,s);i=`(${e} ${1===e?"day":"days"})`}else{const e=formatUtil.daysBetween(n,s);i=`(${e} ${1===e?"day":"days"} remaining)`}r.textContent=`${e} → ${t} ${i}`}else thisItem.release_date?r.textContent=formatUtil.formatDate(thisItem.release_date):r.textContent="Unknown";if(d.textContent=thisItem.is_animated?"Yes":"No",c.innerHTML="","Never for Sale"===thisItem.currency_type?(c.textContent="None",c.className="text-xl font-bold text-gray-700"):"Real Money"===thisItem.currency_type?(c.textContent=`£${thisItem.original_price.toFixed(2)} GBP`,c.className="text-xl font-bold text-gray-700"):"Gold"===thisItem.currency_type?c.innerHTML=`\n      <div class="w-full h-7 bg-gray-100 rounded flex justify-center items-center">\n        <span class="inline-flex items-center text-orange-400 font-bold text-xl mr-1 -ml-1">\n          <img src="../assets/gold_icon.png" \n               alt="Gold" \n               class="w-8 h-8 mr-1">\n          ${thisItem.original_price.toLocaleString()}\n        </span>\n      </div>\n    `:"Credits"===thisItem.currency_type?c.innerHTML=`\n      <div class="w-full h-7 bg-gray-100 rounded flex justify-center items-center">\n        <span class="inline-flex items-center text-gray-500 font-bold text-xl mr-1 -ml-1">\n          <img src="../assets/credits_icon.png" \n               alt="Gold" \n               class="w-8 h-8 mr-1">\n          ${thisItem.original_price.toLocaleString()}\n        </span>\n      </div>\n    `:(c.textContent="Unknown",c.className="text-xl font-bold text-gray-700"),m.textContent=isItemForSale(thisItem)?"For Sale":"Not For Sale",thisItem.min_value&&thisItem.max_value){let e=formatUtil.formatRange(thisItem.min_value,thisItem.max_value);thisItem.min_value===thisItem.max_value&&1==thisItem.ultra_rare&&(e=`${e}+`),l.textContent=e}else l.textContent="Not Assigned"}async function fetchData(){try{const e=await fetch(`https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-item?itemId=${itemId}`,{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(404===e.status)return{error:"NOT_FOUND"};if(!e.ok)return alert("An error occurred. Please refresh to continue."),{error:"API_ERROR",status:e.status};const t=await e.json(),{item:n,category:a}=t||{};return{item:n,category:a}}catch(e){return console.error("Network failure:",e),alert("An error occurred. Please refresh to continue."),{error:"NETWORK_ERROR"}}}function setupItem(e){thisItem=e}function setupCategory(e){thisCategory=e}function calculateItemDates(){thisItem.release_date||(thisItem.release_date=thisCategory.release_date),thisItem.discontinued_date||(thisItem.discontinued_date=thisCategory.discontinued_date)}function handleSuggestValueClicked(){const e={id:thisItem.id,name:thisItem.name,acronym:thisItem.acronym,isUltraRare:thisItem.ultra_rare,category:thisCategory.name,imageUrl:thisItem.image_url};sessionStorage.setItem("suggestionItemDetails",JSON.stringify(e)),window.location.href="../suggest-value/"}async function setupSuggestValueButton(){const e=document.getElementById("suggestValueButton");if(e.classList.add("hidden"),thisItem&&thisCategory&&!isItemForSale(thisItem))try{const{data:{session:t},error:n}=await supabase.auth.getSession();if(n)return void console.error("Error fetching session:",n);if(t){const n=t.user;"council"===n.user_metadata?.role&&(e.addEventListener("click",handleSuggestValueClicked),e.classList.remove("hidden"))}}catch(e){console.error("Unexpected error:",e)}}function setupInsights(e){const t=document.getElementById("insightsContainer");if(!t)return;if(!e.max_value||!e.min_value)return void t.classList.add("hidden");const n=document.getElementById("insightsDate"),a=document.getElementById("insightsSuggestions"),s=document.getElementById("insightsConfidence"),i=document.getElementById("insightsMin"),o=document.getElementById("insightsMax");n.textContent=formatUtil.formatDate(e.council_value_date),a.textContent=e.council_suggestions_count.toLocaleString(),s.textContent=e.confidenceIndicator,i.textContent=e.raw_min_value.toLocaleString(),o.textContent=e.raw_max_value.toLocaleString();const r=document.getElementById("insightsToggle"),d=document.getElementById("insightsContent"),c=document.getElementById("insightsArrow");r.addEventListener("click",()=>{d.classList.toggle("hidden"),c.textContent=d.classList.contains("hidden")?"▼":"▲"}),t.classList.remove("hidden")}async function init(){const e=document.getElementById("loadingSpinner"),t=document.getElementById("itemNotFoundText"),n=document.getElementById("itemContainer");e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden");const{item:a,category:s}=await fetchData();if(setupItem(a),!a)return e.classList.add("hidden"),t.classList.remove("hidden"),void n.classList.add("hidden");setupCategory(s),calculateItemDates(),renderPage(),setupSuggestValueButton(),setupInsights(a),e.classList.add("hidden"),n.classList.remove("hidden")}function handleSearchInputClicked(){sessionStorage.setItem("focusSearch","1"),window.location.href="../catalog/"}window.addEventListener("DOMContentLoaded",()=>{loadSearchBarTextInput(),setSearchPlaceholderText()}),init();const desktopSearchInput=document.getElementById("searchInput"),mobileSearchInput=document.getElementById("searchInputMobile");desktopSearchInput&&desktopSearchInput.addEventListener("click",handleSearchInputClicked),mobileSearchInput&&mobileSearchInput.addEventListener("click",handleSearchInputClicked);