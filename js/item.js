import{supabase}from"../js/supabaseClient.js";import{formatUtil}from"../js/formatUtility.js?v=2025-01-06-02";const params=new URLSearchParams(window.location.search),itemId=params.get("id");function loadSearchBarTextInput(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e);if(t.rawSearch){const e=document.getElementById("searchInput"),n=document.getElementById("searchInputMobile");e&&(e.value=t.rawSearch),n&&(n.value=t.rawSearch)}}function setSearchPlaceholderText(){const e=document.getElementById("searchInput"),t=document.getElementById("searchInputMobile"),n="Search items...";e&&(e.placeholder=n),t&&(t.placeholder=n)}let thisItem,thisCategory,assignedDate,assignedDaysSinceText;function isItemForSale(e){if("Never for Sale"===e.currency_type)return!1;if(!e.discontinued_date)return!0;const t=new Date,n=new Date(e.discontinued_date);return n.setHours(23,59,59,999),t<=n}function renderPage(){const e=document.getElementById("item_name"),t=document.getElementById("item_acronym"),n=document.getElementById("ultra_rare"),a=document.getElementById("item_category"),s=document.getElementById("item_image"),i=document.getElementById("item_type"),o=document.getElementById("item_description"),d=document.getElementById("item_dates"),r=document.getElementById("item_animated"),c=document.getElementById("item_original_price"),l=document.getElementById("item_for_sale"),m=document.getElementById("item_value");if(e.textContent=thisItem.name,document.title=`${thisItem.name} | MP CAT`,thisItem.acronym?(t.classList.remove("hidden"),t.textContent=`(${thisItem.acronym})`):t.classList.add("hidden"),thisItem.ultra_rare?n.classList.remove("hidden"):n.classList.add("hidden"),a.textContent=thisCategory.name+" →",s.src=thisItem.image_url,i.textContent=thisItem.type,o.textContent=thisItem.description,thisItem.release_date&&thisItem.discontinued_date){const e=formatUtil.formatDate(thisItem.release_date),t=formatUtil.formatDate(thisItem.discontinued_date),n=new Date,a=formatUtil.startOfDay(n),s=formatUtil.startOfDay(thisItem.release_date),i=formatUtil.startOfDay(thisItem.discontinued_date),o=formatUtil.endOfDay(thisItem.discontinued_date);let r="",c=0;if(o<=n){const e=formatUtil.daysBetween(s,i)+1;r=`(${e} ${1===e?"day":"days"})`}else if(c=formatUtil.daysBetween(a,i),c>=1){r=`(${c} ${1===c?"day":"days"} remaining)`}else{const e=o-n,t=Math.floor(e/36e5),a=Math.floor(e/6e4);if(t>=1){r=`(${t} ${1===t?"hour":"hours"} remaining)`}else{r=`(${a} ${1===a?"minute":"minutes"} remaining)`}}d.textContent=c>3e4?`${e} → Unknown (30+ days remaining)`:`${e} → ${t} ${r}`}else thisItem.release_date?d.textContent=formatUtil.formatDate(thisItem.release_date):d.textContent="Unknown";if(r.textContent=thisItem.is_animated?"Yes":"No",c.innerHTML="","Never for Sale"===thisItem.currency_type?(c.textContent="None",c.className="text-xl font-bold text-gray-700"):"Real Money"===thisItem.currency_type?(c.textContent=`£${thisItem.original_price.toFixed(2)} GBP`,c.className="text-xl font-bold text-gray-700"):"Gold"===thisItem.currency_type?c.innerHTML=`\n      <div class="w-full h-7 bg-gray-100 rounded flex justify-center items-center">\n        <span class="inline-flex items-center text-orange-400 font-bold text-xl mr-1 -ml-1">\n          <img src="../assets/gold_icon.png" \n               alt="Gold" \n               class="w-8 h-8 mr-1">\n          ${thisItem.original_price.toLocaleString()}\n        </span>\n      </div>\n    `:"Credits"===thisItem.currency_type?c.innerHTML=`\n      <div class="w-full h-7 bg-gray-100 rounded flex justify-center items-center">\n        <span class="inline-flex items-center text-gray-500 font-bold text-xl mr-1 -ml-1">\n          <img src="../assets/credits_icon.png" \n               alt="Gold" \n               class="w-8 h-8 mr-1">\n          ${thisItem.original_price.toLocaleString()}\n        </span>\n      </div>\n    `:(c.textContent="Unknown",c.className="text-xl font-bold text-gray-700"),l.textContent=isItemForSale(thisItem)?"For Sale":"Not For Sale",thisItem.min_value&&thisItem.max_value){let e=formatUtil.formatRange(thisItem.min_value,thisItem.max_value);m.textContent=e}else m.textContent="Not Assigned"}async function fetchData(){try{const e=await fetch(`https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-item?itemId=${itemId}`,{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(404===e.status)return{error:"NOT_FOUND"};if(!e.ok)return alert("An error occurred. Please refresh to continue."),{error:"API_ERROR",status:e.status};const t=await e.json(),{item:n,category:a}=t||{};return{item:n,category:a}}catch(e){return console.error("Network failure:",e),alert("An error occurred. Please refresh to continue."),{error:"NETWORK_ERROR"}}}function setupItem(e){thisItem=e}function setupCategory(e){thisCategory=e}function calculateItemDates(){thisItem.release_date||(thisItem.release_date=thisCategory.release_date),thisItem.discontinued_date||(thisItem.discontinued_date=thisCategory.discontinued_date)}function handleSuggestValueClicked(){const e={id:thisItem.id,name:thisItem.name,acronym:thisItem.acronym,isUltraRare:thisItem.ultra_rare,category:thisCategory.name,imageUrl:thisItem.image_url};sessionStorage.setItem("suggestionItemDetails",JSON.stringify(e)),window.location.href="../suggest-value/"}async function setupSuggestValueButton(){const e=document.getElementById("suggestValueButton"),t=document.getElementById("suggestValueButtonMobile");if(e.classList.add("hidden"),t.classList.add("hidden"),thisItem&&thisCategory&&!isItemForSale(thisItem))try{const{data:{session:n},error:a}=await supabase.auth.getSession();if(a)return void console.error("Error fetching session:",a);if(n){const a=n.user;"council"===a.user_metadata?.role&&(e.addEventListener("click",handleSuggestValueClicked),e.classList.remove("hidden"),t.addEventListener("click",handleSuggestValueClicked),t.classList.remove("hidden"))}}catch(e){console.error("Unexpected error:",e)}}function updateInsightsDate(){window.innerWidth>=768&&desktopSearchInput?insightsDate.innerHTML=`${formatUtil.formatDate(assignedDate)} (${assignedDaysSinceText})`:window.innerWidth<768&&mobileSearchInput&&(insightsDate.innerHTML=`${formatUtil.formatDate(assignedDate)}<br><span class="text-sm">(${assignedDaysSinceText})</span>`)}function setupInsights(e){const t=document.getElementById("insightsContainer");if(!t)return;if(!e.max_value||!e.min_value)return void t.classList.add("hidden");document.getElementById("insightsDate");const n=document.getElementById("insightsSuggestions"),a=document.getElementById("insightsConfidence"),s=document.getElementById("insightsMin"),i=document.getElementById("insightsMax"),o=new Date;assignedDate=new Date(e.council_value_date);const d=formatUtil.daysBetween(assignedDate,o);assignedDaysSinceText=d<=0?"today":1===d?"1 day ago":d>=2&&d<=6?`${d} days ago`:d>=7&&d<=30?"over a week ago":d>30&&d<=365?"over a month ago":"over a year ago",updateInsightsDate(),n.textContent=e.council_suggestions_count.toLocaleString(),a.textContent=e.confidenceIndicator,s.textContent=e.raw_min_value.toLocaleString(),i.textContent=e.raw_max_value.toLocaleString();const r=document.getElementById("insightsToggle"),c=document.getElementById("insightsContent"),l=document.getElementById("insightsArrow");r.addEventListener("click",()=>{c.classList.toggle("hidden"),l.textContent=c.classList.contains("hidden")?"▼":"▲"}),t.classList.remove("hidden")}function showToast(e){const t=document.createElement("div");t.textContent=e,t.className="\n    fixed bottom-4 left-1/2 transform -translate-x-1/2\n    bg-gray-800 text-white px-4 py-2 rounded shadow-lg\n    opacity-0 transition-opacity duration-300\n    z-50 text-center border border-white\n  ",t.style.maxWidth="90%",document.body.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1"}),setTimeout(()=>{t.style.opacity="0",t.addEventListener("transitionend",()=>t.remove())},4e3)}function handleAddItemToTemplate(){const e="tradeTemplateItems";let t,n=localStorage.getItem(e);if(n)try{t=JSON.parse(n)}catch(e){console.error("Failed to parse trade template items from localStorage:",e),t={}}else t={};if(Object.keys(t).length>=15)showToast("Trade Template full");else if(t[thisItem.id])showToast(`${thisItem.name} is already in your Trade Template.`);else{t[thisItem.id]={name:thisItem.name,image:thisItem.image_url};try{localStorage.setItem(e,JSON.stringify(t)),showToast(`${thisItem.name} added to your Trade Template!`)}catch(e){console.warn("Failed to save trade template items:",e),showToast("Failed to add item to template due to error")}}}function setupAddToTemplateButtons(){const e=document.getElementById("addToTemplateButton"),t=document.getElementById("addToTemplateButtonMobile");e&&e.addEventListener("click",handleAddItemToTemplate),t&&t.addEventListener("click",handleAddItemToTemplate)}async function init(){const e=document.getElementById("loadingSpinner"),t=document.getElementById("itemNotFoundText"),n=document.getElementById("itemContainer");e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden");const{item:a,category:s}=await fetchData();if(setupItem(a),!a)return e.classList.add("hidden"),t.classList.remove("hidden"),void n.classList.add("hidden");setupCategory(s),calculateItemDates(),setupAddToTemplateButtons(),renderPage(),setupSuggestValueButton(),setupInsights(a),e.classList.add("hidden"),n.classList.remove("hidden")}function handleSearchInputClicked(){sessionStorage.setItem("focusSearch","1"),window.location.href="../catalog/"}window.addEventListener("DOMContentLoaded",()=>{loadSearchBarTextInput(),setSearchPlaceholderText()}),init();const desktopSearchInput=document.getElementById("searchInput"),mobileSearchInput=document.getElementById("searchInputMobile");function handleCollectionNameClicked(){const e={collection:thisCategory.name,sort:"price",order:"descending",search:"",rawSearch:"",page:1};sessionStorage.setItem("states",JSON.stringify(e)),window.location.href="../catalog/"}desktopSearchInput&&desktopSearchInput.addEventListener("click",handleSearchInputClicked),mobileSearchInput&&mobileSearchInput.addEventListener("click",handleSearchInputClicked);const itemCategory=document.getElementById("item_category");itemCategory.addEventListener("click",handleCollectionNameClicked);const buttonsDesktop=document.getElementById("buttonsDesktop"),buttonsMobile=document.getElementById("buttonsMobile");function toggleItemProfileButtonsStyle(){window.innerWidth>=768&&desktopSearchInput?(buttonsMobile.classList.add("hidden"),buttonsDesktop.classList.remove("hidden")):window.innerWidth<768&&mobileSearchInput&&(buttonsDesktop.classList.add("hidden"),buttonsMobile.classList.remove("hidden"))}const smQuery=window.matchMedia("(min-width: 768px)");function handleBreakpointChange(e){toggleItemProfileButtonsStyle(),updateInsightsDate()}handleBreakpointChange(smQuery),smQuery.addEventListener("change",handleBreakpointChange);