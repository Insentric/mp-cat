const params=new URLSearchParams(window.location.search),itemId=params.get("id");function loadSearchBarTextInput(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e);if(t.rawSearch){const e=document.getElementById("searchInput"),n=document.getElementById("searchInputMobile");e&&(e.value=t.rawSearch),n&&(n.value=t.rawSearch)}}function formatRange(e,t){if(!e)return"";if(!t)return"";let n="",a=1;t>=1e9?(n="B",a=1e9):t>=1e6?(n="M",a=1e6):t>=1e3&&(n="k",a=1e3);let s,i=Math.floor(t/a*100)/100+n;return e===t?`${i}`:(s=e>=1e3&&e<1e6?Math.floor(e/1e3*100)/100:e>=1e6&&e<1e9?Math.floor(e/1e6*100)/100:e>=1e9?Math.floor(e/1e9*100)/100:e,`${s}-${i}`)}let thisItem,thisCategory;function formatDate(e){if(!e)return"";return new Date(e).toLocaleDateString("en-GB")}function daysBetween(e,t){const n=new Date(e),a=new Date(t)-n;return Math.round(a/864e5)}function isItemForSale(e){if(!e.discontinued_date)return!0;const t=new Date;return new Date(e.discontinued_date)>t}function startOfDay(e){const t=new Date(e);return t.setHours(0,0,0,0),t}function renderPage(){const e=document.getElementById("item_name"),t=document.getElementById("item_acronym"),n=document.getElementById("ultra_rare"),a=document.getElementById("item_category"),s=document.getElementById("item_image"),i=document.getElementById("item_type"),r=document.getElementById("item_description"),o=document.getElementById("item_dates"),d=document.getElementById("item_animated"),c=document.getElementById("item_original_price"),m=document.getElementById("item_for_sale"),l=document.getElementById("item_value");if(e.textContent=thisItem.name,document.title=`${thisItem.name} | MP CAT`,thisItem.acronym?(t.classList.remove("hidden"),t.textContent=`(${thisItem.acronym})`):t.classList.add("hidden"),thisItem.ultra_rare?n.classList.remove("hidden"):n.classList.add("hidden"),a.textContent=thisCategory.name,s.src=thisItem.image_url,i.textContent=thisItem.type,r.textContent=thisItem.description,thisItem.release_date&&thisItem.discontinued_date){const e=formatDate(thisItem.release_date),t=formatDate(thisItem.discontinued_date),n=e=>{const t=new Date(e);return t.setHours(0,0,0,0),t},a=n(new Date),s=n(thisItem.release_date),i=n(thisItem.discontinued_date);let r="";if(i<a){const e=daysBetween(s,i);r=`(${e} ${1===e?"day":"days"})`}else{const e=daysBetween(a,i);r=`(${e} ${1===e?"day":"days"} remaining)`}o.textContent=`${e} → ${t} ${r}`}else thisItem.release_date?o.textContent=formatDate(thisItem.release_date):o.textContent="Unknown";if(d.textContent=thisItem.is_animated?"Yes":"No",c.innerHTML="","Never for Sale"===thisItem.currency_type?(c.textContent="None",c.className="text-xl font-bold text-gray-700"):"Real Money"===thisItem.currency_type?(c.textContent=`£${thisItem.original_price.toFixed(2)} GBP`,c.className="text-xl font-bold text-gray-700"):"Gold"===thisItem.currency_type?c.innerHTML=`\n      <div class="flex items-center justify-center">\n        <img src="../assets/gold_icon.png" alt="Gold" class="w-8 h-8 mr-1 -ml-2">\n        <span class="text-orange-400 font-bold">${thisItem.original_price.toLocaleString()}</span>\n      </div>\n    `:"Credits"===thisItem.currency_type?c.innerHTML=`\n      <div class="flex items-center justify-center">\n        <img src="../assets/credits_icon.png" alt="Credits" class="w-8 h-8 mr-1 -ml-2">\n        <span class="text-gray-500 font-bold">${thisItem.original_price.toLocaleString()}</span>\n      </div>\n    `:(c.textContent="Unknown",c.className="text-xl font-bold text-gray-700"),m.textContent=isItemForSale(thisItem)?"For Sale":"Not For Sale",thisItem.min_value&&thisItem.max_value){let e=formatRange(thisItem.min_value,thisItem.max_value);thisItem.min_value===thisItem.max_value&&1==thisItem.ultra_rare&&(e=`${e}+`),l.textContent=e}else l.textContent="Not Assigned"}async function fetchData(){try{const e=await fetch(`https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-item?itemId=${itemId}`,{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(404===e.status)return{error:"NOT_FOUND"};if(!e.ok)return alert("An error occurred. Please refresh to continue."),{error:"API_ERROR",status:e.status};const t=await e.json(),{item:n,category:a}=t||{};return{item:n,category:a}}catch(e){return console.error("Network failure:",e),alert("An error occurred. Please refresh to continue."),{error:"NETWORK_ERROR"}}}function setupItem(e){thisItem=e}function setupCategory(e){thisCategory=e}function calculateItemDates(){thisItem.release_date||(thisItem.release_date=thisCategory.release_date),thisItem.discontinued_date||(thisItem.discontinued_date=thisCategory.discontinued_date)}async function init(){const e=document.getElementById("loadingSpinner"),t=document.getElementById("itemNotFoundText"),n=document.getElementById("itemContainer");e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden");const{item:a,category:s}=await fetchData();if(setupItem(a),!a)return e.classList.add("hidden"),t.classList.remove("hidden"),void n.classList.add("hidden");setupCategory(s),calculateItemDates(),renderPage(),e.classList.add("hidden"),n.classList.remove("hidden")}function handleSearchInputClicked(){sessionStorage.setItem("focusSearch","1"),window.location.href="../catalog/"}window.addEventListener("DOMContentLoaded",()=>{loadSearchBarTextInput()}),init();const desktopSearchInput=document.getElementById("searchInput"),mobileSearchInput=document.getElementById("searchInputMobile");desktopSearchInput&&desktopSearchInput.addEventListener("click",handleSearchInputClicked),mobileSearchInput&&mobileSearchInput.addEventListener("click",handleSearchInputClicked);