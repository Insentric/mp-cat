import{formatUtil}from"../js/formatUtility.js";window.addEventListener("DOMContentLoaded",()=>{if("1"===sessionStorage.getItem("focusSearch")){const e=document.getElementById("searchInput"),t=document.getElementById("searchInputMobile");window.innerWidth>=768&&e?e.focus():window.innerWidth<768&&t&&t.focus(),sessionStorage.removeItem("focusSearch")}});let allItems=[],allCategories=[],categoryReleaseDateMap=[],categoryDiscontinuedDateMap=[];function renderItems(e){const t=document.getElementById("itemsGrid");t.innerHTML="",e.forEach(e=>{let n;if(e.on_sale){const t="Gold"===e.currency_type;n=`<div class="w-full text-center">\n        <span class="inline-flex items-baseline text-base ${t?"text-orange-400":"text-gray-500"}">\n          <img src="${t?"../assets/gold_icon.png":"../assets/credits_icon.png"}" class="w-8 h-8 mr-1 translate-y-2.5" style="vertical-align: text-bottom;" alt="${e.currency_type}">\n          ${e.original_price.toLocaleString()}\n        </span>\n      </div>`}else if(null!=e.min_value&&null!=e.max_value){n=`<div class="w-full text-center pt-2">\n        <span class="text-gray-500 text-base">\n          ${formatUtil.formatRange(e.min_value,e.max_value)}\n        </span>\n      </div>`}else n='<div class="w-full text-center pt-2">\n        <span class="text-gray-500 text-base invisible">placeholder</span>\n      </div>';const a=document.createElement("a");a.href="../item/?id="+e.id,a.className="block";const l=document.createElement("div");l.className="bg-gray-100 rounded-lg p-3 shadow hover:shadow-lg transform transition-transform duration-100 hover:-translate-y-1 cursor-pointer flex flex-col justify-between items-center h-64 w-full max-w-xs",l.innerHTML=`\n      <div class="w-full text-center font-semibold text-gray-700 truncate">\n        ${e.name}\n      </div>\n\n      <img src="${e.image_url}" alt="${e.name}"\n           class="card-image w-32 h-36 object-contain rounded my-2">\n\n      ${n}\n    `,a.appendChild(l);l.querySelector(".card-image").addEventListener("dragstart",e=>e.preventDefault()),t.appendChild(a)})}const ITEMS_PER_PAGE=24;let currentPage=1,searchFilteredItems=[],collectionFilteredItems=[],sortFilteredItems=[],selectedCollection="All",selectedSort="price",selectedOrder="descending",searchInput="",rawSearchInput="";function saveStates(){const e={collection:selectedCollection,sort:selectedSort,order:selectedOrder,search:searchInput,rawSearch:rawSearchInput,page:currentPage};sessionStorage.setItem("states",JSON.stringify(e))}function updateInputsToCurrent(){document.getElementById("sortBySelect").value=selectedSort;document.getElementById("orderingSelect").value=selectedOrder;const e=document.getElementById("collectionsDropdown");[...e.options].some(e=>e.value===selectedCollection)&&(e.value=selectedCollection);const t=document.getElementById("searchInput"),n=document.getElementById("searchInputMobile");t&&(t.value=rawSearchInput),n&&(n.value=rawSearchInput)}function loadStates(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e);t.sort&&(selectedSort=t.sort),t.order&&(selectedOrder=t.order),t.collection&&(selectedCollection=t.collection),t.search&&t.rawSearch&&(searchInput=t.search,rawSearchInput=t.rawSearch),t.page&&(currentPage=t.page),updateInputsToCurrent()}function renderPage(){const e=24*(currentPage-1),t=e+24;renderItems(sortFilteredItems.slice(e,t)),renderPaginationControls()}function renderPaginationControls(){const e=Math.ceil(sortFilteredItems.length/24);document.getElementById("pageIndicatorTop").textContent=`Page ${currentPage} of ${e}`,document.getElementById("pageIndicatorBottom").textContent=`Page ${currentPage} of ${e}`}function setupPaginationButtons(){document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1))}function changePage(e){const t=Math.ceil(sortFilteredItems.length/24);currentPage=Math.min(Math.max(currentPage+e,1),t),saveStates(),renderPage(),window.innerWidth<768&&window.scrollTo({top:0,behavior:"smooth"})}function resetPage(){currentPage=1}function setupItems(e){allItems=e}function sortItemsByValue(e,t){const n=e,a=n.filter(e=>null!=e.min_value&&null!=e.max_value&&!1===e.on_sale);a.sort((e,n)=>{const a=e.max_value??0,l=n.max_value??0;if(a!==l)return(a-l)*t;const r=e.min_value??0,o=n.min_value??0;return r!==o?(r-o)*t:e.name.localeCompare(n.name)*-t});const l=n.filter(e=>!0===e.on_sale).map(e=>{const t="Gold"===e.currency_type?150*e.original_price:e.original_price;return{...e,sortPrice:t}});l.sort((e,n)=>(n.sortPrice-e.sortPrice)*-t);const r=n.filter(e=>null==e.min_value&&null==e.max_value&&!1===e.on_sale);r.sort((e,t)=>e.name.localeCompare(t.name));let o=[];return o=-1===t?[...a,...l,...r]:[...l,...a,...r],o}function updateSortFilteredItems(){let e=[...collectionFilteredItems];const t="ascending"===selectedOrder?1:-1;"price"===selectedSort?e=sortItemsByValue(e,t):"release_date"===selectedSort?e.sort((e,n)=>{const a=new Date(e.release_date||"1900-01-01"),l=new Date(n.release_date||"1900-01-01");return a<l?-1*t:a>l?1*t:e.id<n.id?-1*t:e.id>n.id?1*t:0}):"name"===selectedSort&&e.sort((e,n)=>e.name.localeCompare(n.name)*t),sortFilteredItems=e}function updatePageTitle(e){document.title=e?`${e} | Catalog - MP CAT`:"Catalog - MP CAT"}function updateCollectionFilteredItems(){collectionFilteredItems=searchFilteredItems.filter(e=>{if("All"===selectedCollection)return updatePageTitle(),!0;const t=allCategories.find(e=>e.name===selectedCollection);return t?(updatePageTitle(selectedCollection),e.category===t.id):(updatePageTitle(),!1)})}function setupCollectionFilterListener(){document.getElementById("collectionsDropdown").addEventListener("change",e=>{selectedCollection=e.target.value,resetPage(),saveStates(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage(),window.innerWidth<768&&mobileSearchInput&&(closeFilterPanel(),window.scrollTo({top:0,behavior:"smooth"}))})}function preCalculateItemDates(){allItems.forEach(e=>{const t=categoryReleaseDateMap.get(e.category),n=categoryDiscontinuedDateMap.get(e.category);e.release_date||(e.release_date=t||"1900-01-01"),!e.discontinued_date&&n&&(e.discontinued_date=n)})}function isItemForSale(e){if("Never for Sale"===e.currency_type)return!1;if(!e.discontinued_date)return!0;const t=new Date,n=new Date(e.discontinued_date);return n.setHours(23,59,59,999),t<=n}function preCalculateItemOnSales(){allItems.forEach(e=>{e.on_sale=isItemForSale(e)})}function setupCategories(e){allCategories=e,categoryReleaseDateMap=new Map(allCategories.map(e=>[e.id,e.release_date])),categoryDiscontinuedDateMap=new Map(allCategories.map(e=>[e.id,e.discontinued_date]));const t=document.getElementById("collectionsDropdown");e.forEach(e=>{if("Pre-Release"===e.name||"Collectables"===e.name)return;const n=document.createElement("option");n.value=e.name,n.textContent=e.name,t.appendChild(n)}),setupCollectionFilterListener()}async function fetchData(){try{const e=await fetch("https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-catalog",{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(!e.ok){const t=await e.text();return console.warn("Request failed:",e.status,t),null}const t=await e.json(),{categories:n,items:a}=t||{};return{categories:n,items:a}}catch(e){return console.error("Fetch failed:",e),alert("An error occurred. Please refresh to continue."),null}}function setSearchPlaceholderText(){const e=document.getElementById("searchInput"),t=document.getElementById("searchInputMobile"),n="Search items...";e&&(e.placeholder=n),t&&(t.placeholder=n)}async function init(){window.addEventListener("DOMContentLoaded",()=>{loadStates(),setSearchPlaceholderText(),setFilterPanelFocusable(!1),updateSuggestedCategories()});const e=document.getElementById("loadingSpinner"),t=document.getElementById("itemContainer");e.classList.remove("hidden"),t.classList.add("hidden");const{categories:n,items:a}=await fetchData();setupCategories(n),setupItems(a),preCalculateItemDates(),preCalculateItemOnSales(),loadStates(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage(),e.classList.add("hidden"),t.classList.remove("hidden")}function updateSearchFilteredItems(){searchFilteredItems=allItems.filter(e=>{const t=e.name.toLowerCase().includes(searchInput),n=!!e.acronym&&e.acronym.toLowerCase().includes(searchInput);return t||n})}function onSearchInputChanged(e){searchInput=e.target.value.toLowerCase().trim(),rawSearchInput=e.target.value,updateSearchFilteredItems(),resetPage(),saveStates(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1)),init();const desktopSearchInput=document.getElementById("searchInput"),mobileSearchInput=document.getElementById("searchInputMobile");desktopSearchInput&&desktopSearchInput.addEventListener("input",onSearchInputChanged),mobileSearchInput&&mobileSearchInput.addEventListener("input",onSearchInputChanged);const filterPanel=document.getElementById("filterPanel"),filterButton=document.getElementById("filterButton"),mobileFilterButton=document.getElementById("mobileFilterButton"),closeFilter=document.getElementById("closeFilter"),resetFiltersButton=document.getElementById("resetButton");function setFilterPanelFocusable(e){filterPanel.querySelectorAll("input, select, textarea, button, a").forEach(t=>{e?(t.removeAttribute("tabindex"),t.disabled=!1):(t.setAttribute("tabindex","-1"),t.disabled=!0)})}function openFilterPanel(){filterPanel.classList.remove("translate-x-full"),filterPanel.classList.remove("filterPanel-hidden"),filterPanel.classList.add("filterPanel-visible"),setFilterPanelFocusable(!0)}function closeFilterPanel(){filterPanel.classList.add("translate-x-full"),filterPanel.classList.remove("filterPanel-visible"),filterPanel.classList.add("filterPanel-hidden"),setFilterPanelFocusable(!1)}filterButton?.addEventListener("click",openFilterPanel),mobileFilterButton?.addEventListener("click",openFilterPanel),closeFilter?.addEventListener("click",closeFilterPanel);const sortSelect=document.getElementById("sortBySelect");sortSelect.addEventListener("change",()=>{selectedSort=sortSelect.value,resetPage(),saveStates(),updateSortFilteredItems(),renderPage()});const orderingSelect=document.getElementById("orderingSelect");function resetFilters(){selectedCollection="All",selectedSort="price",selectedOrder="descending",searchInput="",rawSearchInput="",resetPage(),saveStates(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage(),updateInputsToCurrent()}orderingSelect.addEventListener("change",()=>{selectedOrder=orderingSelect.value,resetPage(),saveStates(),updateSortFilteredItems(),renderPage()}),resetFiltersButton?.addEventListener("click",resetFilters);let collectionSearchInput="";function createCollectionButton(e){const t=document.createElement("button");return t.textContent=e,t.className="px-3 py-1 bg-gray-600 rounded hover:bg-gray-500 text-white",t.addEventListener("click",()=>{selectedCollection=e,updateInputsToCurrent(),resetPage(),saveStates(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage(),window.innerWidth<768&&mobileSearchInput&&(closeFilterPanel(),window.scrollTo({top:0,behavior:"smooth"}))}),t}function updateSuggestedCategories(){const e=allCategories.filter(e=>e.name.toLowerCase().includes(collectionSearchInput)&&"Pre-Release"!==e.name&&"Collectables"!==e.name).slice(0,2);collectionsContainer.innerHTML="",collectionsContainer.appendChild(createCollectionButton("All")),collectionsContainer.appendChild(createCollectionButton("Pre-Release")),collectionsContainer.appendChild(createCollectionButton("Collectables")),e.forEach(e=>{collectionsContainer.appendChild(createCollectionButton(e.name))})}const collectionSearch=document.getElementById("collectionSearchInput");collectionSearch.addEventListener("input",e=>{collectionSearchInput=e.target.value.toLowerCase().trim(),updateSuggestedCategories()});