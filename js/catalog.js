function formatRange(e,t){if(!e)return"";if(!t)return"";let n="",a=1;t>=1e9?(n="B",a=1e9):t>=1e6?(n="M",a=1e6):t>=1e3&&(n="k",a=1e3);let r,l=Math.floor(t/a*100)/100+n;return e===t?`${l}`:(r=e>=1e3&&e<1e6?Math.floor(e/1e3*100)/100:e>=1e6&&e<1e9?Math.floor(e/1e6*100)/100:e>=1e9?Math.floor(e/1e9*100)/100:e,`${r}-${l}`)}window.addEventListener("DOMContentLoaded",()=>{if("1"===sessionStorage.getItem("focusSearch")){const e=document.getElementById("searchInput"),t=document.getElementById("searchInputMobile");window.innerWidth>=768&&e?e.focus():window.innerWidth<768&&t&&t.focus(),sessionStorage.removeItem("focusSearch")}});let allItems=[],allCategories=[],categoryReleaseDateMap=[],categoryDiscontinuedDateMap=[];function renderItems(e){const t=document.getElementById("itemsGrid");t.innerHTML="",e.forEach(e=>{let n;if(e.on_sale){const t="Gold"===e.currency_type;n=`<div class="w-full text-center pt-2">\n        <span class="inline-flex items-center ${t?"text-orange-400":"text-gray-500"} text-base">\n          <img src="${t?"../assets/gold_icon.png":"../assets/credits_icon.png"}" class="w-8 h-8 mr-1 inline" alt="${e.currency_type}">\n          ${e.original_price.toLocaleString()}\n        </span>\n      </div>`}else if(null!=e.min_value&&null!=e.max_value){let t=formatRange(e.min_value,e.max_value);e.ultra_rare&&e.min_value===e.max_value&&(t+="+"),n=`<div class="w-full text-center pt-2">\n        <span class="text-gray-500 text-base">\n          ${t}\n        </span>\n      </div>`}else n='<div class="w-full text-center pt-2">\n        <span class="text-gray-500 text-base invisible">placeholder</span>\n      </div>';const a=document.createElement("a");a.href="../item/?id="+e.id,a.className="block";const r=document.createElement("div");r.className="bg-gray-100 rounded-lg p-3 shadow hover:shadow-lg transform transition-transform duration-100 hover:-translate-y-1 cursor-pointer flex flex-col justify-between items-center h-64 w-full max-w-xs",r.innerHTML=`\n      <div class="w-full text-center font-semibold text-gray-700 truncate">\n        ${e.name}\n      </div>\n\n      <img src="${e.image_url}" alt="${e.name}"\n           class="card-image w-32 h-36 object-contain rounded my-2">\n\n      ${n}\n    `,a.appendChild(r);r.querySelector(".card-image").addEventListener("dragstart",e=>e.preventDefault()),t.appendChild(a)})}const ITEMS_PER_PAGE=24;let currentPage=1,searchFilteredItems=[],collectionFilteredItems=[],sortFilteredItems=[],selectedCollection="All",selectedSort="price",selectedOrder="descending",searchInput="",rawSearchInput="";function saveStates(){const e={collection:selectedCollection,sort:selectedSort,order:selectedOrder,search:searchInput,rawSearch:rawSearchInput,page:currentPage};sessionStorage.setItem("states",JSON.stringify(e))}function loadStates(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e),n=document.getElementById("sortBySelect");n&&t.sort&&(n.value=t.sort,selectedSort=t.sort);const a=document.getElementById("orderingSelect");if(a&&t.order&&(a.value=t.order,selectedOrder=t.order),t.collection){selectedCollection=t.collection;const e=document.querySelector(`input[name="collection"][value="${t.collection}"]`);e&&(e.checked=!0)}if(t.search&&t.rawSearch){const e=document.getElementById("searchInput"),n=document.getElementById("searchInputMobile");e&&(e.value=t.rawSearch),n&&(n.value=t.rawSearch),searchInput=t.search}t.page&&(currentPage=t.page)}function renderPage(){const e=24*(currentPage-1),t=e+24;renderItems(sortFilteredItems.slice(e,t)),renderPaginationControls()}function renderPaginationControls(){const e=Math.ceil(sortFilteredItems.length/24);document.getElementById("pageIndicatorTop").textContent=`Page ${currentPage} of ${e}`,document.getElementById("pageIndicatorBottom").textContent=`Page ${currentPage} of ${e}`}function setupPaginationButtons(){document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1))}function changePage(e){const t=Math.ceil(sortFilteredItems.length/24);currentPage=Math.min(Math.max(currentPage+e,1),t),saveStates(),renderPage(),window.innerWidth<768&&window.scrollTo({top:0,behavior:"smooth"})}function resetPage(){currentPage=1}function setupItems(e){allItems=e}function sortItemsByValue(e,t){const n=e,a=n.filter(e=>null!=e.min_value&&null!=e.max_value&&!1===e.on_sale);a.sort((e,n)=>{const a=e.max_value??0,r=n.max_value??0;if(a!==r)return(a-r)*t;const l=e.min_value??0,o=n.min_value??0;return l!==o?(l-o)*t:e.name.localeCompare(n.name)*-t});const r=n.filter(e=>!0===e.on_sale).map(e=>{const t="Gold"===e.currency_type?150*e.original_price:e.original_price;return{...e,sortPrice:t}});r.sort((e,n)=>(n.sortPrice-e.sortPrice)*-t);const l=n.filter(e=>null==e.min_value&&null==e.max_value&&!1===e.on_sale);l.sort((e,t)=>e.name.localeCompare(t.name));let o=[];return o=-1===t?[...a,...r,...l]:[...r,...a,...l],o}function updateSortFilteredItems(){let e=[...collectionFilteredItems];const t="ascending"===selectedOrder?1:-1;"price"===selectedSort?e=sortItemsByValue(e,t):"release_date"===selectedSort?e.sort((e,n)=>{const a=new Date(e.release_date||"1900-01-01"),r=new Date(n.release_date||"1900-01-01");return a<r?-1*t:a>r?1*t:e.id<n.id?-1*t:e.id>n.id?1*t:0}):"name"===selectedSort&&e.sort((e,n)=>e.name.localeCompare(n.name)*t),sortFilteredItems=e}function updatePageTitle(e){document.title=e?`${e} | Catalog - MP CAT`:"Catalog - MP CAT"}function updateCollectionFilteredItems(){collectionFilteredItems=searchFilteredItems.filter(e=>{if("All"===selectedCollection)return updatePageTitle(),!0;const t=allCategories.find(e=>e.name===selectedCollection);return t?(updatePageTitle(selectedCollection),e.category===t.id):(updatePageTitle(),!1)})}function setupCollectionFilterListener(){document.querySelectorAll('input[name="collection"]').forEach(e=>{e.addEventListener("change",()=>{selectedCollection=document.querySelector('input[name="collection"]:checked').value,resetPage(),saveStates(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()})})}function preCalculateItemDates(){allItems.forEach(e=>{const t=categoryReleaseDateMap.get(e.category),n=categoryDiscontinuedDateMap.get(e.category);e.release_date||(e.release_date=t||"1900-01-01"),!e.discontinued_date&&n&&(e.discontinued_date=n)})}function isItemForSale(e){if(!e.discontinued_date)return!0;const t=new Date;return new Date(e.discontinued_date)>t}function preCalculateItemOnSales(){allItems.forEach(e=>{e.on_sale=isItemForSale(e)})}function setupCategories(e){allCategories=e,categoryReleaseDateMap=new Map(allCategories.map(e=>[e.id,e.release_date])),categoryDiscontinuedDateMap=new Map(allCategories.map(e=>[e.id,e.discontinued_date]));const t=document.getElementById("collectionRadios");e.forEach(e=>{if("Pre-Release"===e.name||"Collectables"===e.name)return;const n=document.createElement("label");n.className="flex items-center space-x-3 text-lg";const a=document.createElement("input");a.type="radio",a.name="collection",a.value=e.name,a.className="form-radio";const r=document.createElement("span");r.textContent=e.name,n.appendChild(a),n.appendChild(r),t.appendChild(n)}),setupCollectionFilterListener()}async function fetchData(){try{const e=await fetch("https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-catalog",{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(!e.ok){const t=await e.text();return console.warn("Request failed:",e.status,t),null}const t=await e.json(),{categories:n,items:a}=t||{};return{categories:n,items:a}}catch(e){return console.error("Fetch failed:",e),alert("An error occurred. Please refresh to continue."),null}}async function init(){window.addEventListener("DOMContentLoaded",()=>{loadStates()});const e=document.getElementById("loadingSpinner"),t=document.getElementById("itemContainer");e.classList.remove("hidden"),t.classList.add("hidden");const{categories:n,items:a}=await fetchData();setupCategories(n),setupItems(a),preCalculateItemDates(),preCalculateItemOnSales(),loadStates(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage(),e.classList.add("hidden"),t.classList.remove("hidden")}function updateSearchFilteredItems(){searchFilteredItems=allItems.filter(e=>{const t=e.name.toLowerCase().includes(searchInput),n=!!e.acronym&&e.acronym.toLowerCase().includes(searchInput);return t||n})}function onSearchInputChanged(e){searchInput=e.target.value.toLowerCase().trim(),rawSearchInput=e.target.value,updateSearchFilteredItems(),resetPage(),saveStates(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1)),init();const desktopSearchInput=document.getElementById("searchInput"),mobileSearchInput=document.getElementById("searchInputMobile");desktopSearchInput&&desktopSearchInput.addEventListener("input",onSearchInputChanged),mobileSearchInput&&mobileSearchInput.addEventListener("input",onSearchInputChanged);const filterPanel=document.getElementById("filterPanel"),filterButton=document.getElementById("filterButton"),mobileFilterButton=document.getElementById("mobileFilterButton"),closeFilter=document.getElementById("closeFilter");function openFilterPanel(){filterPanel.classList.remove("translate-x-full")}filterButton?.addEventListener("click",openFilterPanel),mobileFilterButton?.addEventListener("click",openFilterPanel),closeFilter.addEventListener("click",()=>{filterPanel.classList.add("translate-x-full")});const sortSelect=document.getElementById("sortBySelect");sortSelect.addEventListener("change",()=>{selectedSort=sortSelect.value,resetPage(),saveStates(),updateSortFilteredItems(),renderPage()});const orderingSelect=document.getElementById("orderingSelect");orderingSelect.addEventListener("change",()=>{selectedOrder=orderingSelect.value,resetPage(),saveStates(),updateSortFilteredItems(),renderPage()});