let itemsMap;window.addEventListener("DOMContentLoaded",()=>{init()});let selectedBackgroundURL="../assets/background_classic.png";const itemsGrid=document.getElementById("itemsGrid");async function loadItems(){const e=localStorage.getItem("tradeTemplateItems");if(e)try{const t=JSON.parse(e);itemsMap=new Map(Object.entries(t))}catch(e){console.error("Failed to parse tradeTemplateItems from localStorage:",e),itemsMap=new Map}else itemsMap=new Map,console.log("No saved items found, starting with empty template")}function updateItemsCount(){const e=document.getElementById("itemsCount");e&&(itemsMap||(e.textContent="0"),e.textContent=itemsMap.size)}function handleItemClicked(e){itemsMap.has(e)&&(itemsMap.delete(e),localStorage.setItem("tradeTemplateItems",JSON.stringify(Object.fromEntries(itemsMap))),updateItemsCount(),renderItems(itemsGrid))}let saveTimeout;function renderItems(e){e.innerHTML="",itemsMap.forEach((t,n)=>{const a=document.createElement("div");a.className="\n    bg-gray-100 rounded-lg p-2 shadow \n    cursor-pointer relative flex flex-col items-center\n    h-64 w-48\n    ",a.style.userSelect="none";let o=t.price||"";a.innerHTML=`\n\n      \x3c!-- Item name --\x3e\n      <div class="w-full h-10 absolute top-0 p-2 items-center justify-center font-semibold text-gray-700 text-center truncate whitespace-nowrap">\n      ${t.name}\n      </div>\n\n      \x3c!-- Top + middle container --\x3e\n      <div class="flex flex-col items-center mt-6 flex-1">\n        \x3c!-- Item image --\x3e\n        <img src="${t.image}" alt="${t.name}" \n            class="card-image rounded mt-2" style="width:160px; height:160px; object-fit:contain;">\n      </div>\n\n      <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-full h-10 rounded-b-lg overflow-hidden">\n        <div class="w-full h-full bg-white text-gray-700 text-base font-bold\n                    flex items-center justify-center select-none">\n          0\n        </div>\n      </div>\n\n      \x3c!-- Price input at bottom --\x3e\n      <input type="text"\n          value="${o}"\n          placeholder="Price" \n          class="absolute bottom-0 left-1/2 transform -translate-x-1/2\n                  bg-white text-gray-700 text-base font-bold rounded-lg\n                  text-center w-full h-10 focus:outline-none focus:ring-2 focus:ring-orange-500"\n      >\n\n    `;a.querySelector(".card-image").addEventListener("dragstart",e=>e.preventDefault()),a.addEventListener("click",e=>{"input"!==e.target.tagName.toLowerCase()&&handleItemClicked(n)});a.querySelector("input[type='text']").addEventListener("input",e=>{const t=e.target.value;itemsMap.set(n,{...itemsMap.get(n),price:t}),clearTimeout(saveTimeout),saveTimeout=setTimeout(()=>{localStorage.setItem("tradeTemplateItems",JSON.stringify(Object.fromEntries(itemsMap)))},700)}),e.appendChild(a)})}function renderTemplateImageItems(e){e.innerHTML="",itemsMap.forEach((t,n)=>{const a=document.createElement("div");a.className="\n    bg-gray-100 rounded-lg p-2 \n    cursor-pointer relative flex flex-col items-center\n    h-64 w-48\n    ",a.style.userSelect="none";let o="";t.price&&(o=t.price),a.innerHTML=`\n\n      \x3c!-- Item name --\x3e\n      <div class="w-full h-10 absolute top-0 p-2 items-center justify-center font-semibold text-gray-700 text-center truncate overflow-hidden whitespace-nowrap">\n      ${t.name}\n      </div>\n\n      \x3c!-- Top + middle container --\x3e\n      <div class="flex flex-col items-center mt-6 flex-1">\n        \x3c!-- Item image --\x3e\n        <img src="${t.image}" alt="${t.name}" \n            class="card-image rounded mt-2" style="width:160px; height:160px; object-fit:contain;">\n      </div>\n\n      <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-full h-10 rounded-b-lg overflow-hidden">\n        <div class="w-full h-full bg-white text-gray-700 text-base font-bold\n                    flex items-center justify-center select-none">\n          0\n        </div>\n      </div>\n\n      \x3c!-- Price input at bottom --\x3e\n      <input type="text"\n          value="${o}"\n          placeholder=""\n          class="absolute bottom-0 left-1/2 transform -translate-x-1/2\n                  bg-white text-gray-700 text-base font-bold rounded-lg\n                  text-center w-full h-10"\n      >\n    `,e.appendChild(a)})}function clearItems(){itemsMap&&(itemsMap.clear(),localStorage.setItem("tradeTemplateItems",JSON.stringify(Object.fromEntries(itemsMap))),updateItemsCount(),renderItems(itemsGrid))}async function fetchData(){try{const e=await fetch("https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-trade-template",{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(!e.ok){const t=await e.text();return console.warn("Request failed:",e.status,t),null}return{backgroundsData:await e.json()||[]}}catch(e){return console.error("Fetch failed:",e),alert("An error occurred. Please refresh to continue."),null}}let backgrounds={};function setBackground(e){selectedBackgroundURL=e;for(let t of document.styleSheets)try{for(let n of t.cssRules)"#itemContainer::before"===n.selectorText&&(n.style.backgroundImage=`url('${e}')`)}catch(e){continue}}function getCloudinaryPreviewUrl(e,t=300,n=200){try{const a=new URL(e),o=a.pathname.split("/"),r=o.findIndex(e=>"upload"===e);if(-1===r)return e;const s=`w_${t},h_${n},c_fill`;return o.splice(r+1,0,s),a.pathname=o.join("/"),a.toString()}catch(t){return console.warn("Invalid Cloudinary URL:",e),e}}function renderBackgroundGrid(){const e=document.getElementById("backgroundGrid");e&&(e.innerHTML="",backgrounds.forEach(t=>{const n=document.createElement("button");n.className="\n      relative rounded-lg overflow-hidden\n      border-2 border-transparent\n      hover:border-orange-500\n      focus:border-orange-500 focus:outline-none\n      transition\n    ",n.innerHTML=`\n      <img\n        src="${getCloudinaryPreviewUrl(t.image_url)}"\n        alt="Background ${t.id}"\n        class="w-full aspect-video object-cover"\n        loading="lazy"\n      />\n    `,n.addEventListener("click",()=>{setBackground(t.image_url),localStorage.setItem("tradeTemplateBackground",t.image_url),window.innerWidth<768&&(closeBackgroundPanel(),window.scrollTo({top:0,behavior:"smooth"}))}),e.appendChild(n)}))}function loadSelectedBackground(){const e=localStorage.getItem("tradeTemplateBackground");e&&setBackground(e)}async function init(){const e=document.getElementById("itemContainer");loadItems(),updateItemsCount(),renderItems(itemsGrid),loadSelectedBackground(),window.addEventListener("DOMContentLoaded",()=>{setFilterPanelFocusable(!1)}),e.classList.add("bg-visible");const{backgroundsData:t}=await fetchData();backgrounds=t.backgrounds,renderBackgroundGrid()}const clearItemsBtn=document.getElementById("clearItemsBtn");function showToast(e){const t=document.createElement("div");t.textContent=e,t.className="\n    fixed bottom-4 left-1/2 transform -translate-x-1/2\n    bg-gray-800 text-white px-4 py-2 rounded shadow-lg\n    opacity-0 transition-opacity duration-300\n    z-50 text-center border border-white\n  ",t.style.maxWidth="90%",document.body.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1"}),setTimeout(()=>{t.style.opacity="0",t.addEventListener("transitionend",()=>t.remove())},4e3)}async function waitForImagePaint(e){if(e)if(e.complete&&0!==e.naturalWidth){if(e.decode)try{await e.decode()}catch(e){console.warn("Decode failed",e)}await new Promise(e=>requestAnimationFrame(e))}else await new Promise(t=>{e.onload=async()=>{if(e.decode)try{await e.decode()}catch(e){console.warn("Decode failed",e)}requestAnimationFrame(t)},e.onerror=()=>{console.warn("Background failed to load, proceeding anyway"),requestAnimationFrame(t)}})}async function captureOnceGuaranteed(e,t){return await htmlToImage.toPng(e,t),htmlToImage.toPng(e,t)}async function saveTemplateImage(){if(!itemsMap||itemsMap.size<=0)return void showToast("No items in Trade Template.");const e=document.getElementById("templateRender"),t=document.getElementById("templateGrid"),n=document.getElementById("templateRenderBg");if(e&&t&&n){renderTemplateImageItems(t),n.src=selectedBackgroundURL||"../assets/background_classic.png",await waitForImagePaint(n),e.style.opacity=1;try{const t=await captureOnceGuaranteed(e,{width:e.offsetWidth,height:e.offsetHeight,cacheBust:!0}),n=document.createElement("a");n.download="mp-cat-trade-template.png",n.href=t,n.click()}catch(e){console.error("Failed to save template image:",e),showToast("Failed to save image. Please try again.")}finally{e.style.opacity=0}}}clearItemsBtn&&clearItemsBtn.addEventListener("click",clearItems);const saveTemplateBtn=document.getElementById("saveTemplateBtn");saveTemplateBtn&&saveTemplateBtn.addEventListener("click",saveTemplateImage);const backgroundsPanel=document.getElementById("backgroundsPanel"),selectBackgroundBtn=document.getElementById("selectBackgroundBtn"),closePanel=document.getElementById("closePanel");function setBackgroundPanelFocusable(e){backgroundsPanel.querySelectorAll("input, select, textarea, button, a").forEach(t=>{e?(t.removeAttribute("tabindex"),t.disabled=!1):(t.setAttribute("tabindex","-1"),t.disabled=!0)})}function openBackgroundsPanel(){backgroundsPanel.classList.remove("translate-x-full"),backgroundsPanel.classList.remove("backgroundPanel-hidden"),backgroundsPanel.classList.add("backgroundPanel-visible"),setBackgroundPanelFocusable(!0)}function closeBackgroundPanel(){backgroundsPanel.classList.add("translate-x-full"),backgroundsPanel.classList.remove("backgroundPanel-visible"),backgroundsPanel.classList.add("backgroundPanel-hidden"),setBackgroundPanelFocusable(!1)}selectBackgroundBtn?.addEventListener("click",openBackgroundsPanel),closePanel?.addEventListener("click",closeBackgroundPanel);