import{supabase}from"../js/supabaseClient.js";import{formatUtil}from"../js/formatUtility.js";let itemId,isUltraRare=!1,inputtedMinValue=0,inputtedMaxValue=0;function loadSearchBarTextInput(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e);if(t.rawSearch){const e=document.getElementById("searchInput"),n=document.getElementById("searchInputMobile");e&&(e.value=t.rawSearch),n&&(n.value=t.rawSearch)}}function setSearchPlaceholderText(){const e=document.getElementById("searchInput"),t=document.getElementById("searchInputMobile"),n="Search items...";e&&(e.placeholder=n),t&&(t.placeholder=n)}function drawPage(e){const t=document.getElementById("item_name"),n=document.getElementById("item_acronym"),a=document.getElementById("ultra_rare"),s=document.getElementById("item_category"),i=document.getElementById("item_image");t.textContent=e.name,document.title=`${e.name} | Suggest Value - MP CAT`,e.acronym?(n.classList.remove("hidden"),n.textContent=`(${e.acronym})`):n.classList.add("hidden"),e.isUltraRare?a.classList.remove("hidden"):a.classList.add("hidden"),s.textContent=e.category,i.src=e.imageUrl}function loadItemDetails(){const e=sessionStorage.getItem("suggestionItemDetails");if(!e)return;return JSON.parse(e)}window.addEventListener("DOMContentLoaded",()=>{loadSearchBarTextInput(),setSearchPlaceholderText()});const suggestionContent=document.getElementById("suggestionContent"),successContent=document.getElementById("successContent"),failContent=document.getElementById("failContent");async function init(){const e=document.getElementById("loadingSpinner"),t=document.getElementById("unableToLoadText"),n=document.getElementById("itemContainer");e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden"),suggestionContent.classList.add("hidden"),successContent.classList.add("hidden"),failContent.classList.add("hidden"),supabase.auth.getSession().then(({data:{session:a},error:s})=>{if(s)return console.error("Error fetching session:",s),void(window.location.href="../");if(!a)return void(window.location.href="../");const i=a.user;if(!("council"===i.user_metadata?.role))return void(window.location.href="../");const d=loadItemDetails();if(!d)return e.classList.add("hidden"),void t.classList.remove("hidden");itemId=d.id,isUltraRare=d.isUltraRare,drawPage(d),e.classList.add("hidden"),suggestionContent.classList.remove("hidden"),n.classList.remove("hidden")})}function handleSearchInputClicked(){sessionStorage.setItem("focusSearch","1"),window.location.href="../catalog/"}init();const desktopSearchInput=document.getElementById("searchInput"),mobileSearchInput=document.getElementById("searchInputMobile");desktopSearchInput&&desktopSearchInput.addEventListener("click",handleSearchInputClicked),mobileSearchInput&&mobileSearchInput.addEventListener("click",handleSearchInputClicked);const minValueInput=document.getElementById("minValueInput"),maxValueInput=document.getElementById("maxValueInput"),valuePreview=document.getElementById("valuePreview"),submitButton=document.getElementById("submitButton"),suggestionErrorMsg=document.getElementById("suggestionError");function showFailMessage(e){suggestionContent.classList.remove("hidden"),successContent.classList.add("hidden"),failContent.classList.remove("hidden"),suggestionErrorMsg.textContent=e||"Unable to submit suggestion! Please try again."}function showSuccessMessage(){suggestionContent.classList.add("hidden"),successContent.classList.remove("hidden"),failContent.classList.add("hidden")}async function handleSubmitSuggestion(){const e=document.getElementById("submitContainer"),t=document.getElementById("submitSpinner");e.classList.add("hidden"),t.classList.remove("hidden");const{data:{session:n},error:a}=await supabase.auth.getSession();if(a||!n)return void(window.location.href="../");if(null==inputtedMinValue||null==inputtedMaxValue)return e.classList.remove("hidden"),t.classList.add("hidden"),void showFailMessage("Missing suggested values.");if(0===inputtedMinValue||0===inputtedMaxValue)return e.classList.remove("hidden"),t.classList.add("hidden"),void showFailMessage("Suggested values must be at least 1000.");if(inputtedMinValue<1e3||inputtedMaxValue<1e3)return e.classList.remove("hidden"),t.classList.add("hidden"),void showFailMessage("Suggested values must be at least 1000.");if(inputtedMaxValue<inputtedMinValue)return e.classList.remove("hidden"),t.classList.add("hidden"),void showFailMessage("Max value cannot be less than min value.");const s=JSON.stringify({itemIdRaw:itemId,minValueRaw:inputtedMinValue,maxValueRaw:inputtedMaxValue}),i=await fetch("https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/suggest-value",{method:"POST",headers:{Authorization:`Bearer ${n.access_token}`,"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306","Content-Type":"application/json"},body:s});if(i.ok)e.classList.add("hidden"),t.classList.add("hidden"),showSuccessMessage();else{await i.json().catch(()=>({}));e.classList.remove("hidden"),t.classList.add("hidden"),showFailMessage()}}function updateValuePreview(){if(null==inputtedMinValue||null==inputtedMaxValue)return void(valuePreview.textContent="");if(0===inputtedMinValue||0===inputtedMaxValue)return void(valuePreview.textContent="");if(inputtedMaxValue<inputtedMinValue)return void(valuePreview.textContent="");let e=formatUtil.formatRange(inputtedMinValue,inputtedMaxValue);valuePreview.textContent=e}minValueInput.addEventListener("input",()=>{inputtedMinValue=formatUtil.getValidNumber(minValueInput),updateValuePreview()}),maxValueInput.addEventListener("input",()=>{inputtedMaxValue=formatUtil.getValidNumber(maxValueInput),updateValuePreview()}),submitButton.addEventListener("click",handleSubmitSuggestion);