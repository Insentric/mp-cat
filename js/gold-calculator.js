function loadSearchBarTextInput(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e);if(t.rawSearch){const e=document.getElementById("searchInput"),n=document.getElementById("searchInputMobile");e&&(e.value=t.rawSearch),n&&(n.value=t.rawSearch)}}function setSearchPlaceholderText(){const e=document.getElementById("searchInput"),t=document.getElementById("searchInputMobile"),n="Search items...";e&&(e.placeholder=n),t&&(t.placeholder=n)}window.addEventListener("DOMContentLoaded",()=>{loadSearchBarTextInput(),setSearchPlaceholderText()});let allItems=[],allCategories=[],categoryReleaseDateMap=[],categoryMap=[],goldItemList=[],pricePerGold=0,totalGold=0,totalCredits=0;const totalGoldValue=document.getElementById("totalGoldValue"),totalCreditsValue=document.getElementById("totalCreditsValue");function copyGoldList(){if(0===goldItemList.length)return void showToast("Your list is empty!");goldItemList.sort((e,t)=>t.category-e.category);let e="My MP CAT Gold Items List:\n\n";goldItemList.forEach(t=>{e+=`${t.quantity}x ${t.name} - [${categoryMap[t.category]}]\n`}),e+=`\nPrice Per Gold: ${pricePerGold.toLocaleString()}`,e+=`\nTotal Gold: ${totalGold.toLocaleString()}`,e+=`\nTotal Credits: ${totalCredits.toLocaleString()}`,navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e).then(()=>showToast("Copied to clipboard!")).catch(()=>fallbackCopy(e)):fallbackCopy(e)}function fallbackCopy(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.top="-9999px",document.body.appendChild(t),t.focus(),t.select();try{showToast(document.execCommand("copy")?"Copied to clipboard!":"Could not copy to clipboard.")}catch(e){console.error("Fallback copy failed",e),showToast("Could not copy to clipboard.")}document.body.removeChild(t)}function showToast(e){const t=document.createElement("div");t.textContent=e,t.className="\n    fixed bottom-4 left-1/2 transform -translate-x-1/2\n    bg-gray-800 text-white px-4 py-2 rounded shadow-lg\n    opacity-0 transition-opacity duration-300\n    z-50 text-center border border-white\n  ",t.style.maxWidth="90%",document.body.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1"}),setTimeout(()=>{t.style.opacity="0",t.addEventListener("transitionend",()=>t.remove())},2e3)}const goldListCount=document.getElementById("goldListCount"),maxGoldListCountNumber=99;function updateGoldListCount(e){goldListCount&&(goldListCount.textContent=e>99?"99":e)}function calculateItemTotals(){totalGold=0;let e=0;goldItemList.forEach(t=>{totalGold+=t.quantity*t.original_price,e+=t.quantity}),updateGoldListCount(e),totalCredits=totalGold*pricePerGold,totalGoldValue.textContent=totalGold.toLocaleString(),totalCreditsValue.textContent=totalCredits.toLocaleString()}function handleItemClicked(e){const t=goldItemList.find(t=>t.id===e.id);t?t.quantity+=1:goldItemList.push({...e,quantity:1}),renderGoldListItems(goldItemList),calculateItemTotals()}function handleSelectedItemClicked(e){const t=goldItemList.find(t=>t.id===e.id);t&&(t.quantity-=1,0===t.quantity&&(goldItemList=goldItemList.filter(t=>t.id!==e.id))),renderGoldListItems(goldItemList),calculateItemTotals()}const currencyIconSrc="../assets/gold_icon.png",valueColorClass="text-orange-400";function renderItems(e){const t=document.getElementById("itemsGrid");t.innerHTML="",e.forEach(e=>{let n;n=`<div class="w-full text-center">\n      <span class="inline-flex items-baseline text-base ${valueColorClass}">\n        <img src="${currencyIconSrc}" class="w-8 h-8 mr-1 translate-y-2.5" style="vertical-align: text-bottom;" alt="${e.currency_type}">\n        ${e.original_price.toLocaleString()}\n      </span>\n    </div>`;const o=document.createElement("div");o.className="bg-gray-100 rounded-lg p-2 shadow md:hover:shadow-lg transform transition-transform duration-100 md:hover:-translate-y-1 cursor-pointer flex flex-col items-center h-30 w-full max-w-xs",o.style.userSelect="none",o.style.webkitUserSelect="none",o.style.mozUserSelect="none",o.style.msUserSelect="none",o.innerHTML=`\n      \x3c!-- Quantity badge --\x3e\n      <div class="absolute bottom-1 left-1 w-6 h-6 bg-orange-500 text-white text-lg font-bold rounded-full flex items-center justify-center shadow">\n        +\n      </div>\n\n      <div class="w-full text-center font-semibold text-gray-700 truncate">\n        ${e.name}\n      </div>\n\n      <img src="${e.image_url}" alt="${e.name}"\n           class="card-image w-16 h-16 object-contain rounded my-2">\n\n      ${n}\n    `;o.querySelector(".card-image").addEventListener("dragstart",e=>e.preventDefault()),o.addEventListener("click",()=>{handleItemClicked(e)}),t.appendChild(o)})}function renderGoldListItems(e){const t=document.getElementById("selectedItemsGrid");t.innerHTML="",e.forEach(e=>{let n;n=`<div class="w-full text-center">\n      <span class="inline-flex items-baseline text-base ${valueColorClass}">\n        <img src="${currencyIconSrc}" class="w-8 h-8 mr-1 translate-y-2.5" style="vertical-align: text-bottom;" alt="${e.currency_type}">\n        ${e.original_price.toLocaleString()}\n      </span>\n    </div>`;const o=document.createElement("div");o.className="bg-gray-100 rounded-lg p-2 shadow md:hover:shadow-lg transform transition-transform duration-100 md:hover:-translate-y-1 cursor-pointer flex flex-col items-center h-30 w-full max-w-xs",o.style.userSelect="none",o.style.webkitUserSelect="none",o.style.mozUserSelect="none",o.style.msUserSelect="none",o.innerHTML=`\n      \x3c!-- Quantity badge --\x3e\n      <div class="absolute bottom-1 left-1 bg-white text-sm font-bold px-2 py-1 rounded shadow text-gray-600">\n        ${e.quantity}\n      </div>\n\n      \x3c!-- Item content --\x3e\n      <div class="w-full text-center font-semibold text-gray-700 truncate">\n        ${e.name}\n      </div>\n\n      <img src="${e.image_url}" alt="${e.name}"\n           class="card-image w-16 h-16 object-contain rounded my-2">\n\n      ${n}\n    `;o.querySelector(".card-image").addEventListener("dragstart",e=>e.preventDefault()),o.addEventListener("click",()=>{handleSelectedItemClicked(e)}),t.appendChild(o)})}function debounce(e,t){let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>{e(...o)},t)}}const ITEMS_PER_PAGE=24;let currentPage=1,searchFilteredItems=[],collectionFilteredItems=[],sortFilteredItems=[],selectedCollection="All",selectedSort="price",selectedOrder="descending",searchInput="";function renderPage(){const e=24*(currentPage-1),t=e+24;renderItems(sortFilteredItems.slice(e,t)),renderPaginationControls()}function renderPaginationControls(){const e=Math.ceil(sortFilteredItems.length/24);document.getElementById("pageIndicatorTop").textContent=`Page ${currentPage} of ${e}`,document.getElementById("pageIndicatorBottom").textContent=`Page ${currentPage} of ${e}`}function setupPaginationButtons(){document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1))}function changePage(e){const t=Math.ceil(sortFilteredItems.length/24);currentPage=Math.min(Math.max(currentPage+e,1),t),renderPage(),window.innerWidth<768&&window.scrollTo({top:0,behavior:"smooth"})}function resetPage(){currentPage=1}function setupItems(e){allItems=e}function updateSortFilteredItems(){let e=[...collectionFilteredItems];const t="ascending"===selectedOrder?1:-1;e.sort((e,n)=>{const o=new Date(e.release_date||"1900-01-01"),a=new Date(n.release_date||"1900-01-01");return o<a?-1*t:o>a?1*t:e.id<n.id?-1*t:e.id>n.id?1*t:0}),sortFilteredItems=e}function updateCollectionFilteredItems(){collectionFilteredItems=searchFilteredItems.filter(e=>{if("All"===selectedCollection)return!0;const t=allCategories.find(e=>e.name===selectedCollection);return!!t&&e.category===t.id})}function preCalculateItemDates(){allItems.forEach(e=>{if(!e.release_date){const t=categoryReleaseDateMap.get(e.category);e.release_date=t||"1900-01-01"}})}function removeDiscontinuedCategories(){const e=new Date,t=allCategories.filter(t=>{if(!t.discontinued_date)return!1;const n=new Date(t.discontinued_date);return n.setHours(23,59,59,999),e>n}).map(e=>e.id);allCategories=allCategories.filter(e=>!t.includes(e.id))}function updateSuggestedCategories(){const e=allCategories.filter(e=>e.name.toLowerCase().includes(searchInput)&&"Collectables"!==e.name).slice(0,3);collectionsContainer.innerHTML="";const t=document.createElement("button");t.textContent="All",t.className="px-3 py-1 bg-gray-700 rounded hover:bg-gray-500",t.addEventListener("click",()=>{selectedCollection="All",searchInput="",resetPage(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),collectionsContainer.appendChild(t);const n=document.createElement("button");n.textContent="Collectables",n.className="px-3 py-1 bg-gray-700 rounded hover:bg-gray-500",n.addEventListener("click",()=>{selectedCollection="Collectables",searchInput="",resetPage(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),collectionsContainer.appendChild(n),e.forEach(e=>{const t=document.createElement("button");t.textContent=e.name,t.className="px-3 py-1 bg-gray-700 rounded hover:bg-gray-500",t.addEventListener("click",()=>{selectedCollection=e.name,searchInput="",resetPage(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),collectionsContainer.appendChild(t)})}function setupCategories(e){allCategories=e,categoryMap=Object.fromEntries(e.map(e=>[e.id,e.name]))}async function fetchData(){try{const e=await fetch("https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-gold-calculator",{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(!e.ok){const t=await e.text();return console.warn("Request failed:",e.status,t),null}const t=await e.json(),{categories:n,onSaleItems:o}=t||{};return{categories:n,onSaleItems:o}}catch(e){return console.error("Fetch failed:",e),alert("An error occurred. Please refresh to continue."),null}}async function init(){const e=document.getElementById("loadingSpinner"),t=(document.getElementById("itemContainer"),document.getElementById("mainContainer"));t.classList.add("hidden"),e.classList.remove("hidden");const{categories:n,onSaleItems:o}=await fetchData();setupCategories(n),setupItems(o),removeDiscontinuedCategories(),categoryReleaseDateMap=new Map(allCategories.map(e=>[e.id,e.release_date])),preCalculateItemDates(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),updateSuggestedCategories(),renderPage(),calculateItemTotals(),t.classList.remove("hidden"),e.classList.add("hidden")}function updateSearchFilteredItems(){searchFilteredItems=allItems.filter(e=>{const t=e.name.toLowerCase().includes(searchInput),n=!!e.acronym&&e.acronym.toLowerCase().includes(searchInput);return t||n})}document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1)),init(),document.getElementById("copyListBtn").addEventListener("click",()=>{copyGoldList()}),document.getElementById("ratioInput").addEventListener("input",()=>{const e=ratioInput.value.trim();if(isNaN(e)||""===e)return;const t=Number(e);pricePerGold=t,calculateItemTotals()});const goldSearchInput=document.getElementById("goldSearchInput");function handleSearchInputClicked(){sessionStorage.setItem("focusSearch","1"),window.location.href="../catalog/"}goldSearchInput.addEventListener("input",e=>{searchInput=e.target.value.toLowerCase().trim(),updateSuggestedCategories(),updateSearchFilteredItems(),resetPage(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),goldSearchInput.addEventListener("click",function(){searchInput=goldSearchInput.value,selectedCollection="All",updateSuggestedCategories(),updateSearchFilteredItems(),resetPage(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()});const desktopSearchInput=document.getElementById("searchInput"),mobileSearchInput=document.getElementById("searchInputMobile");desktopSearchInput&&desktopSearchInput.addEventListener("click",handleSearchInputClicked),mobileSearchInput&&mobileSearchInput.addEventListener("click",handleSearchInputClicked);const goldPanel=document.getElementById("goldPanel");function openGoldPanel(){const e=document.getElementById("goldPanel");e.classList.remove("hidden"),e.offsetWidth,e.classList.remove("translate-y-full","opacity-0"),window.innerWidth<768&&window.scrollTo({top:0,behavior:"smooth"})}function closeGoldPanel(){const e=document.getElementById("goldPanel");e.classList.add("translate-y-full","opacity-0"),setTimeout(()=>e.classList.add("hidden"),300)}document.getElementById("openGoldPanel")?.addEventListener("click",()=>{openGoldPanel()}),document.getElementById("closeGoldPanel")?.addEventListener("click",()=>{closeGoldPanel()});