function loadSearchBarTextInput(){const e=sessionStorage.getItem("states");if(!e)return;const t=JSON.parse(e);t.search&&(document.getElementById("searchInput").value=t.search)}function formatRange(e,t){if(!e)return"";if(!t)return"";let n="",a=1;t>=1e9?(n="B",a=1e9):t>=1e6?(n="M",a=1e6):t>=1e3&&(n="k",a=1e3);let o,l=Math.floor(t/a*100)/100+n;return e===t?`${l}`:(o=e>=1e3&&e<1e6?Math.floor(e/1e3*100)/100:e>=1e6&&e<1e9?Math.floor(e/1e6*100)/100:e>=1e9?Math.floor(e/1e9*100)/100:e,`${o}-${l}`)}window.addEventListener("DOMContentLoaded",()=>{loadSearchBarTextInput()});let allItems=[],allCategories=[],categoryReleaseDateMap=[],categoryMap=[],goldItemList=[],pricePerGold=0,totalGold=0,totalCredits=0;const totalGoldValue=document.getElementById("totalGoldValue"),totalCreditsValue=document.getElementById("totalCreditsValue");function copyGoldList(){if(0===goldItemList.length)return void alert("Your list is empty!");goldItemList.sort((e,t)=>t.category-e.category);let e="My MP CAT Gold Items List:\n\n";goldItemList.forEach(t=>{e+=`${t.quantity}x ${t.name} - [${categoryMap[t.category]}]\n`}),e+=`\nPrice Per Gold: ${pricePerGold.toLocaleString()}`,e+=`\nTotal Gold: ${totalGold.toLocaleString()}`,e+=`\nTotal Credits: ${totalCredits.toLocaleString()}`,navigator.clipboard.writeText(e).then(()=>{alert("Copied to clipboard!")}).catch(e=>{console.error("Failed to copy:",e),alert("Could not copy to clipboard.")})}function calculateItemTotals(){totalGold=0,goldItemList.forEach(e=>{totalGold+=e.quantity*e.original_price}),totalCredits=totalGold*pricePerGold,totalGoldValue.textContent=totalGold.toLocaleString(),totalCreditsValue.textContent=totalCredits.toLocaleString()}function handleItemClicked(e){const t=goldItemList.find(t=>t.id===e.id);t?t.quantity+=1:goldItemList.push({...e,quantity:1}),renderGoldListItems(goldItemList),calculateItemTotals()}function handleSelectedItemClicked(e){const t=goldItemList.find(t=>t.id===e.id);t&&(t.quantity-=1,0===t.quantity&&(goldItemList=goldItemList.filter(t=>t.id!==e.id))),renderGoldListItems(goldItemList),calculateItemTotals()}const currencyIconSrc="../assets/gold_icon.png",valueColorClass="text-orange-400";function renderItems(e){const t=document.getElementById("itemsGrid");t.innerHTML="",e.forEach(e=>{let n;n=`<div class="w-full text-center pt-2">\n      <span class="inline-flex items-center ${valueColorClass} text-base">\n        <img src="${currencyIconSrc}" class="w-8 h-8 mr-1 inline">\n        ${e.original_price.toLocaleString()}\n      </span>\n    </div>`;const a=document.createElement("div");a.className="bg-gray-100 rounded-lg p-2 shadow hover:shadow-lg transform transition-transform duration-100 hover:-translate-y-1 cursor-pointer flex flex-col items-center h-30 w-full max-w-xs",a.style.userSelect="none",a.style.webkitUserSelect="none",a.style.mozUserSelect="none",a.style.msUserSelect="none",a.innerHTML=`\n      <div class="w-full text-center font-semibold text-gray-700 truncate">\n        ${e.name}\n      </div>\n\n      <img src="${e.image_url}" alt="${e.name}"\n           class="card-image w-16 h-16 object-contain rounded my-2">\n\n      ${n}\n    `;a.querySelector(".card-image").addEventListener("dragstart",e=>e.preventDefault()),a.addEventListener("click",()=>{handleItemClicked(e)}),t.appendChild(a)})}function renderGoldListItems(e){const t=document.getElementById("selectedItemsGrid");t.innerHTML="",e.forEach(e=>{let n;n=`<div class="w-full text-center pt-2">\n      <span class="inline-flex items-center ${valueColorClass} text-base">\n        <img src="${currencyIconSrc}" class="w-8 h-8 mr-1 inline">\n        ${e.original_price.toLocaleString()}\n      </span>\n    </div>`;const a=document.createElement("div");a.className="relative bg-gray-100 border border-gray-200 rounded-lg p-2 shadow hover:shadow-lg transform transition-transform duration-100 hover:-translate-y-1 cursor-pointer flex flex-col items-center h-30 w-full max-w-xs",a.style.userSelect="none",a.style.webkitUserSelect="none",a.style.mozUserSelect="none",a.style.msUserSelect="none",a.innerHTML=`\n      \x3c!-- Quantity badge --\x3e\n      <div class="absolute bottom-1 left-1 bg-white text-sm font-bold px-2 py-1 rounded shadow text-gray-600">\n        ${e.quantity}\n      </div>\n\n      \x3c!-- Item content --\x3e\n      <div class="w-full text-center font-semibold text-gray-700 truncate">\n        ${e.name}\n      </div>\n\n      <img src="${e.image_url}" alt="${e.name}"\n           class="card-image w-16 h-16 object-contain rounded my-2">\n\n      ${n}\n    `;a.querySelector(".card-image").addEventListener("dragstart",e=>e.preventDefault()),a.addEventListener("click",()=>{handleSelectedItemClicked(e)}),t.appendChild(a)})}function debounce(e,t){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>{e(...a)},t)}}const ITEMS_PER_PAGE=24;let currentPage=1,searchFilteredItems=[],collectionFilteredItems=[],sortFilteredItems=[],selectedCollection="All",selectedSort="price",selectedOrder="descending",searchInput="";function renderPage(){const e=24*(currentPage-1),t=e+24;renderItems(sortFilteredItems.slice(e,t)),renderPaginationControls()}function renderPaginationControls(){const e=Math.ceil(sortFilteredItems.length/24);document.getElementById("pageIndicatorTop").textContent=`Page ${currentPage} of ${e}`,document.getElementById("pageIndicatorBottom").textContent=`Page ${currentPage} of ${e}`}function setupPaginationButtons(){document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1))}function changePage(e){const t=Math.ceil(sortFilteredItems.length/24);currentPage=Math.min(Math.max(currentPage+e,1),t),renderPage()}function resetPage(){currentPage=1}function setupItems(e){allItems=e}function updateSortFilteredItems(){let e=[...collectionFilteredItems];const t="ascending"===selectedOrder?1:-1;e.sort((e,n)=>{const a=new Date(e.release_date||"1900-01-01"),o=new Date(n.release_date||"1900-01-01");return a<o?-1*t:a>o?1*t:e.id<n.id?-1*t:e.id>n.id?1*t:0}),sortFilteredItems=e}function updateCollectionFilteredItems(){collectionFilteredItems=searchFilteredItems.filter(e=>{if("All"===selectedCollection)return!0;const t=allCategories.find(e=>e.name===selectedCollection);return!!t&&e.category===t.id})}function preCalculateItemDates(){allItems.forEach(e=>{if(!e.release_date){const t=categoryReleaseDateMap.get(e.category);e.release_date=t||"1900-01-01"}})}function removeAllOffSaleItemsAndCategories(){const e=new Date,t=allCategories.filter(t=>null!=t.discontinued_date&&new Date(t.discontinued_date)<=e).map(e=>e.id);allItems=allItems.filter(e=>!t.includes(e.category_id)),allCategories=allCategories.filter(e=>!t.includes(e.id))}function updateSuggestedCategories(){const e=allCategories.filter(e=>e.name.toLowerCase().includes(searchInput)&&"Collectables"!==e.name).slice(0,3);collectionsContainer.innerHTML="";const t=document.createElement("button");t.textContent="All",t.className="px-3 py-1 bg-gray-700 rounded hover:bg-gray-500",t.addEventListener("click",()=>{selectedCollection="All",searchInput="",resetPage(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),collectionsContainer.appendChild(t);const n=document.createElement("button");n.textContent="Collectables",n.className="px-3 py-1 bg-gray-700 rounded hover:bg-gray-500",n.addEventListener("click",()=>{selectedCollection="Collectables",searchInput="",resetPage(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),collectionsContainer.appendChild(n),e.forEach(e=>{const t=document.createElement("button");t.textContent=e.name,t.className="px-3 py-1 bg-gray-700 rounded hover:bg-gray-500",t.addEventListener("click",()=>{selectedCollection=e.name,searchInput="",resetPage(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),collectionsContainer.appendChild(t)})}function setupCategories(e){allCategories=e,categoryMap=Object.fromEntries(e.map(e=>[e.id,e.name]))}async function fetchData(){try{const e=await fetch("https://ihqgfedofjqucmeerbua.supabase.co/functions/v1/get-gold-calculator",{method:"GET",headers:{"x-api-key":"827f3a6abb3e26bd0cd0c1cba37bb73cf0099a9de2cb4f367586d848a4513306"}});if(!e.ok){const t=await e.text();return console.warn("Request failed:",e.status,t),null}const t=await e.json(),{categories:n,items:a}=t||{};return{categories:n,items:a}}catch(e){return console.error("Fetch failed:",e),alert("An error occurred. Please refresh to continue."),null}}async function init(){const e=document.getElementById("loadingSpinner"),t=document.getElementById("itemContainer");e.classList.remove("hidden"),t.classList.add("hidden");const{categories:n,items:a}=await fetchData();setupCategories(n),setupItems(a),removeAllOffSaleItemsAndCategories(),categoryReleaseDateMap=new Map(allCategories.map(e=>[e.id,e.release_date])),preCalculateItemDates(),updateSearchFilteredItems(),updateCollectionFilteredItems(),updateSortFilteredItems(),updateSuggestedCategories(),renderPage(),calculateItemTotals(),e.classList.add("hidden"),t.classList.remove("hidden")}function updateSearchFilteredItems(){searchFilteredItems=allItems.filter(e=>{const t=e.name.toLowerCase().includes(searchInput),n=!!e.acronym&&e.acronym.toLowerCase().includes(searchInput);return t||n})}document.getElementById("prevPageTop").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageTop").addEventListener("click",()=>changePage(1)),document.getElementById("prevPageBottom").addEventListener("click",()=>changePage(-1)),document.getElementById("nextPageBottom").addEventListener("click",()=>changePage(1)),init(),document.getElementById("copyListBtn").addEventListener("click",()=>{copyGoldList()}),document.getElementById("ratioInput").addEventListener("input",()=>{const e=ratioInput.value.trim();if(isNaN(e)||""===e)return;const t=Number(e);pricePerGold=t,calculateItemTotals()});const goldSearchInput=document.getElementById("goldSearchInput");goldSearchInput.addEventListener("input",e=>{searchInput=e.target.value.toLowerCase().trim(),updateSuggestedCategories(),updateSearchFilteredItems(),resetPage(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),goldSearchInput.addEventListener("click",function(){searchInput=goldSearchInput.value,selectedCollection="All",updateSuggestedCategories(),updateSearchFilteredItems(),resetPage(),updateCollectionFilteredItems(),updateSortFilteredItems(),renderPage()}),document.getElementById("searchInput").addEventListener("click",function(){sessionStorage.setItem("focusSearch","1"),window.location.href="/catalog/"});